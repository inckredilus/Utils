#!/data/data/com.termux/files/usr/bin/bash
#
# Clean up old or stuck background processes in Termux
# without killing Termux itself or the current shell.
#
# Usage:
#   cleanup.sh            â†’ cleans up normally
#   cleanup.sh --dry-run  â†’ shows what it *would* clean up
#

DRY_RUN=false
if [ "$1" == "--dry-run" ]; then
    DRY_RUN=true
    echo "ğŸ§ª Running in DRY-RUN mode â€” no processes will be killed."
    echo
fi

echo "ğŸ” Checking for old Termux background processes..."
echo

# Helper function
run_or_print() {
    if $DRY_RUN; then
        echo "â†’ Would run: $*"
    else
        eval "$@" 2>/dev/null
    fi
}

# --- 1ï¸âƒ£ termux-notification ---
if pgrep -f termux-notification >/dev/null; then
    run_or_print pkill -f termux-notification && echo "ğŸ§­ termux-notification processes cleared."
else
    echo "ğŸ§­ No termux-notification processes found."
fi

# --- 2ï¸âƒ£ termux-toast, termux-vibrate etc. ---
if pgrep -f "termux-(toast|vibrate)" >/dev/null; then
    run_or_print pkill -f "termux-(toast|vibrate)" && echo "ğŸ“³ termux-toast/vibrate processes cleared."
else
    echo "ğŸ“³ No termux-toast/vibrate processes found."
fi

# --- 3ï¸âƒ£ Background scripts in $HOME ---
if pgrep -f "/data/data/com.termux/files/home/" >/dev/null; then
    run_or_print pkill -f "/data/data/com.termux/files/home/" && echo "ğŸ“ Background scripts in \$HOME cleared."
else
    echo "ğŸ“ No background scripts found in \$HOME."
fi

# --- 4ï¸âƒ£ Orphaned sh processes ---
orphans=$(ps -u $(whoami) | grep -E ' /data/data/com.termux/files/usr/bin/sh' | awk '{print $1}')
if [ -n "$orphans" ]; then
    echo "ğŸ’€ Found orphaned sh processes:"
    echo "$orphans"
    for pid in $orphans; do
        if [ "$pid" != "$$" ]; then
            run_or_print kill "$pid" && echo "   â†’ Killed orphaned sh process ($pid)."
        fi
    done
else
    echo "ğŸ’€ No orphaned sh processes found."
fi

# --- 5ï¸âƒ£ termux-dialog processes (even those launched via bash) ---
dialog_pids=$(ps -ef | grep 'termux-dialog' | grep -v grep | awk '{print $2}')
if [ -n "$dialog_pids" ]; then
    echo "ğŸ—¨ï¸  Found termux-dialog processes:"
    echo "$dialog_pids"
    for pid in $dialog_pids; do
        run_or_print kill "$pid" && echo "   â†’ Killed termux-dialog process ($pid)."
    done
else
    echo "ğŸ—¨ï¸  No termux-dialog processes found."
fi

echo
echo "âœ… Cleanup complete."
